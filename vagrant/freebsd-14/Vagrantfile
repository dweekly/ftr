# -*- mode: ruby -*-
# vi: set ft=ruby :

# Load shared configuration modules
require_relative '../lib/base_config'
require_relative '../lib/rust_installer'

Vagrant.configure("2") do |config|
  # Use official FreeBSD box
  config.vm.box = "freebsd/FreeBSD-14.0-STABLE"
  
  # VM identification
  config.vm.hostname = "ftr-freebsd-14"
  config.vm.define "ftr-freebsd-14"
  
  # Apply base configuration
  BaseConfig.configure_base(config, {
    memory: 2048,
    cpus: 2
  })
  
  # Configure network (FreeBSD = .2)
  BaseConfig.configure_network(config, 2)
  
  # Configure shared folder
  BaseConfig.configure_shared_folder(config, :freebsd)
  
  # VM name for provider
  config.vm.provider "parallels" do |prl|
    prl.name = "ftr-freebsd-14"
  end
  
  # FreeBSD uses sh instead of bash by default
  config.vm.provision "shell", inline: <<-SHELL
    set -e
    
    echo "=== FreeBSD 14 Development Environment ==="
    
    # Update system and install packages
    pkg update -f
    pkg install -y git curl bash sudo rust
    
    # Create ftr user
    if ! pw user show ftr >/dev/null 2>&1; then
      pw useradd ftr -m -s /bin/sh -G wheel
      echo 'ftr' | pw usermod ftr -h 0
      echo '%wheel ALL=(ALL) NOPASSWD: ALL' >> /usr/local/etc/sudoers
    fi
    
    # Set up SSH access
    mkdir -p /home/ftr/.ssh
    cp /home/vagrant/.ssh/authorized_keys /home/ftr/.ssh/
    chown -R ftr:ftr /home/ftr/.ssh
    chmod 700 /home/ftr/.ssh
    chmod 600 /home/ftr/.ssh/authorized_keys
    
    # Ensure shared folder mount point exists
    mkdir -p /media/psf
    chown ftr:ftr /media/psf || true
    
    # Install Rust via rustup if pkg version is too old
    if ! command -v rustup >/dev/null 2>&1; then
      #{RustInstaller.install_rust_script('ftr', :freebsd)}
    else
      echo "Rust already installed via pkg"
    fi
    
    # Install development tools
    sudo -u ftr sh -c '. $HOME/.cargo/env 2>/dev/null && cargo install cargo-audit cargo-machete cargo-outdated' || true
    
    echo "=== FreeBSD 14 setup complete! ==="
  SHELL
  
  # Post-up message
  config.vm.post_up_message = <<-MSG
    FreeBSD 14 Development VM is ready!
    
    VM IP: 192.168.36.2
    SSH: ssh -i ~/.ssh/ftr_vm_key ftr@192.168.36.2
    Project: /media/psf/ftr
  MSG
end