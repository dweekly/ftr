# -*- mode: ruby -*-
# vi: set ft=ruby :

# Load shared configuration modules
require_relative '../lib/base_config'
require_relative '../lib/rust_installer'

Vagrant.configure("2") do |config|
  # Use official OpenBSD box
  config.vm.box = "generic/openbsd7"
  
  # VM identification
  config.vm.hostname = "ftr-openbsd-75"
  config.vm.define "ftr-openbsd-75"
  
  # Apply base configuration
  BaseConfig.configure_base(config, {
    memory: 2048,
    cpus: 2
  })
  
  # Configure network (OpenBSD = .3)
  BaseConfig.configure_network(config, 3)
  
  # Configure shared folder (OpenBSD uses different path)
  BaseConfig.configure_shared_folder(config, :openbsd)
  
  # VM name for provider
  config.vm.provider "parallels" do |prl|
    prl.name = "ftr-openbsd-7.5"
  end
  
  # OpenBSD specific provisioning
  config.vm.provision "shell", inline: <<-SHELL
    set -e
    
    echo "=== OpenBSD 7.5 Development Environment ==="
    
    # Update system and install packages
    pkg_add -I git curl bash rust
    
    # Create ftr user
    if ! id -u ftr >/dev/null 2>&1; then
      useradd -m -G wheel -s /bin/ksh ftr
      echo 'ftr:ftr' | chpasswd
      echo 'permit nopass :wheel' > /etc/doas.conf
    fi
    
    # Set up SSH access
    mkdir -p /home/ftr/.ssh
    cp /home/vagrant/.ssh/authorized_keys /home/ftr/.ssh/
    chown -R ftr:ftr /home/ftr/.ssh
    chmod 700 /home/ftr/.ssh
    chmod 600 /home/ftr/.ssh/authorized_keys
    
    # Create project directory in home (OpenBSD shared folders can be tricky)
    mkdir -p /home/ftr/ftr
    chown ftr:ftr /home/ftr/ftr
    
    # Install Rust if not available via pkg_add
    if ! command -v rustc >/dev/null 2>&1; then
      #{RustInstaller.install_rust_script('ftr', :openbsd)}
    else
      echo "Rust already installed via pkg_add"
    fi
    
    echo "=== OpenBSD 7.5 setup complete! ==="
  SHELL
  
  # Post-up message
  config.vm.post_up_message = <<-MSG
    OpenBSD 7.5 Development VM is ready!
    
    VM IP: 192.168.36.3
    SSH: ssh -i ~/.ssh/ftr_vm_key ftr@192.168.36.3
    Project: /home/ftr/ftr
    
    Note: OpenBSD uses doas instead of sudo
  MSG
end